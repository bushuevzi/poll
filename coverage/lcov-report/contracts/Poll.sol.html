<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts\Poll.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> Poll.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>61/61</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>36/36</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>15/15</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>61/61</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">114×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">19×</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-yes">36×</span>
<span class="cline-any cline-yes">35×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">34×</span>
<span class="cline-any cline-yes">99×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">34×</span>
<span class="cline-any cline-yes">34×</span>
<span class="cline-any cline-yes">34×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">50×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">50×</span>
<span class="cline-any cline-yes">49×</span>
<span class="cline-any cline-yes">48×</span>
<span class="cline-any cline-yes">47×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">46×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">45×</span>
<span class="cline-any cline-yes">45×</span>
<span class="cline-any cline-yes">45×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-yes">14×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-yes">39×</span>
<span class="cline-any cline-yes">39×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">39×</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">//SPDX-License-Identifier: Unlicense
pragma solidity ^0.8.0;
import "hardhat/console.sol";
&nbsp;
contract Poll {
    struct PollMeta{
        address[] candidatesLUT;
        address[] electorsLUT;
        address winner;
        uint prize;
        uint comission;
        uint startTime;
        bool isFinished;
        bool isComissionWidsdrawed;
    }
&nbsp;
    struct PollFullInfo{
        PollMeta meta;
        // mappings for O(1) algorims
        mapping (address =&gt; bool) electors;
        mapping (address =&gt; bool) candidates;
        mapping (address =&gt; uint) votes;   
    }
&nbsp;
    address public _owner;
    uint public _voteCost = 0.01 ether;
    uint public _comissionTax = 10;
    mapping (string =&gt; PollFullInfo) public _polls;
    string[] private _pollsLUT;
&nbsp;
    constructor() {
        _owner = msg.sender;
    }
&nbsp;
    function kill() external {
        require(msg.sender == _owner, "Only the owner can kill this contract");
        selfdestruct(payable(_owner));
    }
&nbsp;
    function createPoll(string memory pollName, uint startTime, address[] memory candidates) public {
        PollFullInfo storage targetPoll = _polls[pollName];
&nbsp;
        require(msg.sender == _owner, "You should be contract owner");
        require(targetPoll.meta.startTime == 0, "Poll exists");
        require(candidates.length &gt; 0, "Candidates list empty");
&nbsp;
        for(uint i = 0; i &lt; candidates.length; i++){
            targetPoll.candidates[candidates[i]] = true;
        }
        targetPoll.meta.candidatesLUT = candidates;
        targetPoll.meta.startTime = startTime;
        _pollsLUT.push(pollName);
    }
&nbsp;
    function vote(string memory pollName, address favoriteCandidate) public payable {
        PollFullInfo storage targetPoll = _polls[pollName];
&nbsp;
        require(targetPoll.meta.startTime &gt; 0, "Poll not found");
        require(targetPoll.electors[msg.sender] == false, "You alrady voted");
        require(block.timestamp &lt; targetPoll.meta.startTime + 3 days, "Poll is expired");
        require(msg.value == _voteCost, "You need to send 0.01 Ether");
                
        require(targetPoll.candidates[favoriteCandidate] == true, "Favorite candidate is not a poll member");
&nbsp;
        targetPoll.electors[msg.sender] = true;
        targetPoll.meta.electorsLUT.push(msg.sender);
        targetPoll.votes[favoriteCandidate] += 1; // vote
    }
&nbsp;
    function finish(string memory pollName) public {
        PollFullInfo storage targetPoll = _polls[pollName];
&nbsp;
        require(targetPoll.meta.startTime &gt; 0, "Poll not found");
        require(targetPoll.meta.isFinished == false, "Poll allrady finished");
        require(block.timestamp &gt;= targetPoll.meta.startTime + 3 days, "Voting lasts less than 3 days");
&nbsp;
        uint _prize = getPrize(pollName);
        address payable _winner = payable(calcWinner(pollName));
        _winner.transfer(_prize);
        
        targetPoll.meta.comission = calcComission(pollName);
        targetPoll.meta.prize = _prize;
        targetPoll.meta.winner = _winner;
        targetPoll.meta.isFinished = true;
    }
&nbsp;
    function withdrawComission(string memory pollName) public {
        PollFullInfo storage targetPoll = _polls[pollName];
&nbsp;
        require(msg.sender == _owner, "You should be contract owner");
        require(targetPoll.meta.startTime &gt; 0, "Poll not found");
        require(targetPoll.meta.isFinished == true, "Poll not finished");
        require(targetPoll.meta.comission &gt; 0, "Comission is empty");
        require(targetPoll.meta.isComissionWidsdrawed == false, "Comission was already widthdraw");
&nbsp;
        payable(_owner).transfer(targetPoll.meta.comission);
        targetPoll.meta.isComissionWidsdrawed = true;
    }
&nbsp;
    function getPolls() public view returns(string[] memory) {
        return _pollsLUT;
    }
&nbsp;
    function getPoll(string memory pollName) public view returns(PollMeta memory) {
        return _polls[pollName].meta;
    }
&nbsp;
    function getPollCandidates(string memory pollName) public view returns(address[] memory) {
        return _polls[pollName].meta.candidatesLUT;
    }
&nbsp;
    function getElectors(string memory pollName) public view returns(address[] memory) {
        return _polls[pollName].meta.electorsLUT;
    }
&nbsp;
    function getWinner(string memory pollName) public view returns(address) {
        return _polls[pollName].meta.winner;
    }
&nbsp;
    function getVotesForCandidate(string memory pollName, address candidate) public view returns(uint) {
        return _polls[pollName].votes[candidate];
    }
&nbsp;
    function getPrize(string memory pollName) private view returns (uint) {
        uint prizeWithComission = _polls[pollName].meta.electorsLUT.length * _voteCost;
        uint _comission = calcComission(pollName);
        return prizeWithComission - _comission;
    }
&nbsp;
    function calcComission (string memory pollName) private view returns (uint) {
        uint _priseWithComission = _polls[pollName].meta.electorsLUT.length * _voteCost;
        return _priseWithComission / 100 * _comissionTax;
    }
&nbsp;
    function calcWinner (string memory pollName) private view returns (address) {
        address winner;
        uint maxVotes = 0;
        PollFullInfo storage targetPoll = _polls[pollName];
&nbsp;
        for(uint i = 0; i &lt; targetPoll.meta.candidatesLUT.length; i++){
            address candidate = targetPoll.meta.candidatesLUT[i];
            uint candidateVotes = targetPoll.votes[candidate];
&nbsp;
            if(candidateVotes &gt;= maxVotes) {
                winner = candidate;
                maxVotes = candidateVotes;
            }
        }
&nbsp;
        return winner;
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Mar 30 2022 02:42:37 GMT+0300 (Москва, стандартное время)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
